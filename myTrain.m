clear; close all;

net = alexnet;
opts = trainingOptions('sgdm','InitialLearnRate',0.001);
layers = net.Layers;

layers(end - 2) = fullyConnectedLayer(65);
layers(end) = classificationLayer;

letDs = imageDatastore('ann','IncludeSubfolders',true,'LabelSource','foldernames','ReadFcn',@readImg);

[trainDs,testDs] = splitEachLabel(letDs,0.9,'randomized');
[plateNet,info] = trainNetwork(trainDs,layers,opts);

save PlateAlexNet.mat plateNet;

function img = readImg(file)
    img = imread(file);
    if(size(img,3) == 1)
        img = repmat(img,[1 1 3]);
    end
    
    img = imresize(img,[227 227]);
end



% 
% Training on single GPU.
% Initializing image normalization.
% |=========================================================================================|
% |     Epoch    |   Iteration  | Time Elapsed |  Mini-batch  |  Mini-batch  | Base Learning|
% |              |              |  (seconds)   |     Loss     |   Accuracy   |     Rate     |
% |=========================================================================================|
% |            1 |            1 |         0.51 |       4.6768 |        0.00% |       0.0010 |
% |            1 |           50 |        20.29 |       0.6809 |       84.38% |       0.0010 |
% |            1 |          100 |        40.61 |       0.3971 |       86.72% |       0.0010 |
% |            2 |          150 |        60.70 |       0.1662 |       96.09% |       0.0010 |
% |            2 |          200 |        80.87 |       0.0986 |       96.09% |       0.0010 |
% |            3 |          250 |       100.99 |       0.0705 |       96.88% |       0.0010 |
% |            3 |          300 |       121.08 |       0.1150 |       97.66% |       0.0010 |
% |            4 |          350 |       141.14 |       0.0564 |       98.44% |       0.0010 |
% |            4 |          400 |       161.25 |       0.0637 |       96.88% |       0.0010 |
% |            4 |          450 |       181.96 |       0.0174 |      100.00% |       0.0010 |
% |            5 |          500 |       203.89 |       0.0070 |      100.00% |       0.0010 |
% |            5 |          550 |       225.11 |       0.0878 |       97.66% |       0.0010 |
% |            6 |          600 |       245.26 |       0.0056 |      100.00% |       0.0010 |
% |            6 |          650 |       265.38 |       0.0086 |      100.00% |       0.0010 |
% |            7 |          700 |       285.55 |       0.0211 |       98.44% |       0.0010 |
% |            7 |          750 |       305.73 |       0.0249 |       99.22% |       0.0010 |
% |            8 |          800 |       326.75 |       0.0179 |       99.22% |       0.0010 |
% |            8 |          850 |       350.48 |       0.0261 |       99.22% |       0.0010 |
% |            8 |          900 |       373.47 |       0.0182 |       99.22% |       0.0010 |
% |            9 |          950 |       396.24 |       0.0342 |       99.22% |       0.0010 |
% |            9 |         1000 |       419.64 |       0.0042 |      100.00% |       0.0010 |
% |           10 |         1050 |       443.36 |       0.0146 |       99.22% |       0.0010 |
% |           10 |         1100 |       465.94 |       0.0025 |      100.00% |       0.0010 |
% |           11 |         1150 |       489.14 |       0.0617 |       99.22% |       0.0010 |
% |           11 |         1200 |       514.15 |       0.0064 |      100.00% |       0.0010 |
% |           12 |         1250 |       540.10 |       0.0024 |      100.00% |       0.0010 |
% |           12 |         1300 |       566.37 |       0.0014 |      100.00% |       0.0010 |
% |           12 |         1350 |       589.63 |       0.0017 |      100.00% |       0.0010 |
% |           13 |         1400 |       610.99 |       0.0015 |      100.00% |       0.0010 |
% |           13 |         1450 |       634.16 |       0.0039 |      100.00% |       0.0010 |
% |           14 |         1500 |       657.43 |       0.0049 |      100.00% |       0.0010 |
% |           14 |         1550 |       680.69 |       0.0115 |      100.00% |       0.0010 |
% |           15 |         1600 |       705.02 |       0.0027 |      100.00% |       0.0010 |
% |           15 |         1650 |       728.28 |       0.0015 |      100.00% |       0.0010 |
% |           16 |         1700 |       752.73 |       0.0053 |      100.00% |       0.0010 |
% |           16 |         1750 |       777.16 |       0.0464 |       99.22% |       0.0010 |
% |           16 |         1800 |       801.68 |       0.0007 |      100.00% |       0.0010 |
% |           17 |         1850 |       825.07 |       0.0012 |      100.00% |       0.0010 |
% |           17 |         1900 |       847.78 |       0.0042 |      100.00% |       0.0010 |
% |           18 |         1950 |       869.85 |       0.0064 |      100.00% |       0.0010 |
% |           18 |         2000 |       891.96 |       0.0015 |      100.00% |       0.0010 |
% |           19 |         2050 |       913.16 |       0.0087 |      100.00% |       0.0010 |
% |           19 |         2100 |       935.58 |       0.0130 |       99.22% |       0.0010 |
% |           20 |         2150 |       958.40 |       0.0035 |      100.00% |       0.0010 |
% |           20 |         2200 |       981.14 |       0.0012 |      100.00% |       0.0010 |
% |           20 |         2250 |      1003.44 |       0.0180 |       98.44% |       0.0010 |
% |           21 |         2300 |      1026.06 |       0.0010 |      100.00% |       0.0010 |
% |           21 |         2350 |      1047.06 |       0.1145 |       98.44% |       0.0010 |
% |           22 |         2400 |      1067.80 |       0.0008 |      100.00% |       0.0010 |
% |           22 |         2450 |      1088.39 |       0.0032 |      100.00% |       0.0010 |
% |           23 |         2500 |      1109.47 |       0.0028 |      100.00% |       0.0010 |
% |           23 |         2550 |      1132.03 |       0.0003 |      100.00% |       0.0010 |
% |           24 |         2600 |      1154.40 |       0.0146 |       99.22% |       0.0010 |
% |           24 |         2650 |      1176.35 |       0.0256 |       99.22% |       0.0010 |
% |           24 |         2700 |      1197.94 |       0.0056 |      100.00% |       0.0010 |
% |           25 |         2750 |      1220.57 |       0.0387 |       99.22% |       0.0010 |
% |           25 |         2800 |      1243.44 |       0.0001 |      100.00% |       0.0010 |
% |           26 |         2850 |      1265.41 |       0.0003 |      100.00% |       0.0010 |
% |           26 |         2900 |      1287.66 |       0.0024 |      100.00% |       0.0010 |
% |           27 |         2950 |      1310.93 |       0.0116 |       99.22% |       0.0010 |
% |           27 |         3000 |      1333.80 |       0.0002 |      100.00% |       0.0010 |
% |           27 |         3050 |      1354.53 |       0.0005 |      100.00% |       0.0010 |
% |           28 |         3100 |      1375.36 |       0.0099 |       99.22% |       0.0010 |
% |           28 |         3150 |      1396.57 |       0.0063 |      100.00% |       0.0010 |
% |           29 |         3200 |      1418.05 |       0.0013 |      100.00% |       0.0010 |
% |           29 |         3250 |      1439.80 |       0.0018 |      100.00% |       0.0010 |
% |           30 |         3300 |      1460.91 |       0.0004 |      100.00% |       0.0010 |
% |           30 |         3350 |      1481.86 |       0.0030 |      100.00% |       0.0010 |
% |           30 |         3390 |      1498.73 |       0.0010 |      100.00% |       0.0010 |
% |=========================================================================================|